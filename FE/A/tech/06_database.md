# データベース技術
# 01 データベース
一定の規則に従って、関連性のあるデータを蓄積したもの

## データモデル
データベースを設計する際に、実世界におけるデータの集合をデータベース上で利用可能にするもの

### 関係モデル
データの関係を集合論などで数学モデルで表現したもの

- Relation(関係): 表・テーブル
- Attribute(属性): 列・項目・カラム
- Tuple(タプル・組): 行・レコード
- Domain(定義域): 整数型・文字列型

### 関係データベース(RDB: リレーショナルデータベース)
行と列から構成される2次元の表によって表現されるデータベース

## スキーマ
- スキーマ: データの形式や性質、ほかのデータとの関連などのデータ定義の集合です。

**3層スキーマ**

- 外部: 利用者やアプリケーションからみたデータベースの構造で、概念スキーマから必要な部分を取り出して、定義したもの(ビューなどが該当)
- 概念: 開発者から見たデータ項目やデータベースの構造を定義したもの(表が該当する)
- 内部: データベースを記録媒体に、データを格納するための物理的な構造を定義したもの

## データベース管理システム
複数の利用者で大量のデータを共同利用できるように管理するソフトウェア

- 保全機能: 参照制約や排他制御など、データの完全性を保つ機能
- 障害回復機能: ロールフォワードやロールバックなど、データベースの障害を回復する機能
- 機密保護機能: ユーザ認証やアクセス制御など、データの改ざんや漏洩を未然に防ぐ機能

再編成: データベースに対する変更操作が繰り返されると、データの物理的格納位置が不規則になったり、削除領域が利用できなくなったりする状態になる。これを修復して、アクセス性能を向上させること

# 02 データベース設計

## 設計
### E-R図
対象業務を構成する実体と実体間の関連を視覚的に表した図

- エンティティ: 実体
- リレーションシップ: 実体間の関連

4種類あり、1対1・1対多・多対1・多対多

## 表の設計
### 主キー
表中の一意に識別するための列、一意制約、非NULL制約

### 外部キー
他の表の主キーを参照している列

参照制約: 関係する表間で参照一貫性が維持されるよう制約される

インデックス: どのデータがどこにあるか示したもの。索引の意味がある

# 03 データの正規化
**データの正規化**:必要なデータ項目を整理して、データが重複しないように表を分割すること

- 非正規系: 正規化されていない表
- 第1正規形: 繰返し項目を排除する。計算で求められる項目を削除する
  - 複合主キー: 複数の列を組み合わせることで、行を一意に特定する
-  第2正規形: 主キーの一部の項目によって決まる項目を、別の表に分離する
  - 部分関数従属: 主キーの一部の項目によって、項目が一意に決まる関係
  - 完全関数従属: 主キーによって、項目が一意に決まる関係
- 第3正規形: 主キー以外の項目によって決まる項目を、別の表に分離する
  - 推移的関数従属: 主キー以外の項目によって、項目が一意に決まる関係

# 04 トランザクション処理
データベース更新時に切り離すことができない一連の処理

**ACID特性(トランザクション処理の特性)**
- 原子性(Atomicity): トランザクション処理がすべて完了したか、全く処理されていないかで終了する
- 一貫性(Consistency): データベースの内容に矛盾がないこと
- 独立性(Isolation): 複数のトランザクションを同時に実行した場合と、順番に実行した場合の処理結果が一致すること
- 耐久性(Durability): トランザクションが正常終了すると、更新結果は障害が発生してもデータベースから消失しないこと

## 排他制御
データベース更新時にデータの不整合が発生しないように、データの更新中はアクセスを制限(ロック)して、別のトランザクションからアクセスできないように制御する

排他制御の目的は、**データの不整合を防ぐこと**

### 共有ロックと専有ロック
- 共有ロック(読み取り): トランザクションがデータを参照する前にかけるロック
  - 共有ロック中は、他のトランザクションから共有ロックは可能。専有ロックは不可。共有ロック中のデータに対して、他のトランザクションからは参照可能だが、更新できない
- 専有ロック(更新): トランザクションがデータを更新する前にかけるロック
  - 他のトランザクションから共有・専有ロックは不可。

### ロックの粒度
ロックの粒度を大きくすると、他のトランザクション処理に待ち状態が多く発生し、全体のスループットが低下する

例
- 表単位: 粒度が大きすぎる
- 行単位: 表単位のように競合は起こらないが、ロックの粒度が小さいので、管理するロック数が増えることで、DBMSのメモリ領域が多く必要になる


## デッドロック
複数のトランザクションが互いに相手が専有ロックしている資源に要求して待ち状態となり、実行できなくなる状態

デッドロックが発生すると、トランザクションをDBMSがロールバックしてロックを開放する

## 2相コミットメント
分散型データベースシステムにおいて、一連のトランザクション処理を行う複数サイトに更新処理が確定可能か問い合わせた後、全てのサイトが可能であれば、更新処理を確定する方式

結果は、コミットするか、ロールバックするかのどちらかになる

# 05 データベースの障害回復



























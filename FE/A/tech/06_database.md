# データベース技術
# 01 データベース
一定の規則に従って、関連性のあるデータを蓄積したもの

## データモデル
データベースを設計する際に、実世界におけるデータの集合をデータベース上で利用可能にするもの

### 関係モデル
データの関係を集合論などで数学モデルで表現したもの

- Relation(関係): 表・テーブル
- Attribute(属性): 列・項目・カラム
- Tuple(タプル・組): 行・レコード
- Domain(定義域): 整数型・文字列型

### 関係データベース(RDB: リレーショナルデータベース)
行と列から構成される2次元の表によって表現されるデータベース

## スキーマ
- スキーマ: データの形式や性質、ほかのデータとの関連などのデータ定義の集合です。

**3層スキーマ**

- 外部: 利用者やアプリケーションからみたデータベースの構造で、概念スキーマから必要な部分を取り出して、定義したもの(ビューなどが該当)
- 概念: 開発者から見たデータ項目やデータベースの構造を定義したもの(表が該当する)
- 内部: データベースを記録媒体に、データを格納するための物理的な構造を定義したもの

## データベース管理システム
複数の利用者で大量のデータを共同利用できるように管理するソフトウェア

- 保全機能: 参照制約や排他制御など、データの完全性を保つ機能
- 障害回復機能: ロールフォワードやロールバックなど、データベースの障害を回復する機能
- 機密保護機能: ユーザ認証やアクセス制御など、データの改ざんや漏洩を未然に防ぐ機能

再編成: データベースに対する変更操作が繰り返されると、データの物理的格納位置が不規則になったり、削除領域が利用できなくなったりする状態になる。これを修復して、アクセス性能を向上させること

# 02 データベース設計

## 設計
### E-R図
対象業務を構成する実体と実体間の関連を視覚的に表した図

- エンティティ: 実体
- リレーションシップ: 実体間の関連

4種類あり、1対1・1対多・多対1・多対多

## 表の設計
### 主キー
表中の一意に識別するための列、一意制約、非NULL制約

### 外部キー
他の表の主キーを参照している列

参照制約: 関係する表間で参照一貫性が維持されるよう制約される

インデックス: どのデータがどこにあるか示したもの。索引の意味がある

# 03 データの正規化
**データの正規化**:必要なデータ項目を整理して、データが重複しないように表を分割すること

- 非正規系: 正規化されていない表
- 第1正規形: 繰返し項目を排除する。計算で求められる項目を削除する
  - 複合主キー: 複数の列を組み合わせることで、行を一意に特定する
-  第2正規形: 主キーの一部の項目によって決まる項目を、別の表に分離する
  - 部分関数従属: 主キーの一部の項目によって、項目が一意に決まる関係
  - 完全関数従属: 主キーによって、項目が一意に決まる関係
- 第3正規形: 主キー以外の項目によって決まる項目を、別の表に分離する
  - 推移的関数従属: 主キー以外の項目によって、項目が一意に決まる関係

# 04 トランザクション処理
データベース更新時に切り離すことができない一連の処理

**ACID特性(トランザクション処理の特性)**
- 原子性(Atomicity): トランザクション処理がすべて完了したか、全く処理されていないかで終了する
- 一貫性(Consistency): データベースの内容に矛盾がないこと
- 独立性(Isolation): 複数のトランザクションを同時に実行した場合と、順番に実行した場合の処理結果が一致すること
- 耐久性(Durability): トランザクションが正常終了すると、更新結果は障害が発生してもデータベースから消失しないこと

## 排他制御
データベース更新時にデータの不整合が発生しないように、データの更新中はアクセスを制限(ロック)して、別のトランザクションからアクセスできないように制御する

排他制御の目的は、**データの不整合を防ぐこと**

### 共有ロックと専有ロック
- 共有ロック(読み取り): トランザクションがデータを参照する前にかけるロック
  - 共有ロック中は、他のトランザクションから共有ロックは可能。専有ロックは不可。共有ロック中のデータに対して、他のトランザクションからは参照可能だが、更新できない
- 専有ロック(更新): トランザクションがデータを更新する前にかけるロック
  - 他のトランザクションから共有・専有ロックは不可。

### ロックの粒度
ロックの粒度を大きくすると、他のトランザクション処理に待ち状態が多く発生し、全体のスループットが低下する

例
- 表単位: 粒度が大きすぎる
- 行単位: 表単位のように競合は起こらないが、ロックの粒度が小さいので、管理するロック数が増えることで、DBMSのメモリ領域が多く必要になる


## デッドロック
複数のトランザクションが互いに相手が専有ロックしている資源に要求して待ち状態となり、実行できなくなる状態

デッドロックが発生すると、トランザクションをDBMSがロールバックしてロックを開放する

## 2相コミットメント
分散型データベースシステムにおいて、一連のトランザクション処理を行う複数サイトに更新処理が確定可能か問い合わせた後、全てのサイトが可能であれば、更新処理を確定する方式

結果は、コミットするか、ロールバックするかのどちらかになる

# 05 データベースの障害回復
## ログファイル
- フルバックアップファイル: データベースの全データをバックアップしたもの
- ログファイル(ジャーナルファイル): データベースの更新前や更新後の値を書き出して、データベースの更新記録をとったもの

## データベースの障害回復
- ロールフォワード: データベースのハードウェア障害に対して、フルバックアップ時点の状態に復元した後、**ログファイルの更新後情報**を使用して復旧させる方法
- ロールバック: トランザクション処理プログラムが、データベースの更新途中に異常終了した場合に、**ログファイルの更新前情報**を使用して復旧させる方法

### チェックポイント
トランザクションがコミットされると、メモリ上のバッファとログファイルが書き出される。メモリ上のバッファからのデータベースの更新は、チェックポイントのタイミングで一括して反映させます。

チェックポイント以降にコミットした後、障害が発生したトランザクションは、ロールフォワードで障害発生の直前の状態まで回復させる。障害発生時にまだコミットされていないトランザクションは、ロールバックでトランザクション開始時点の状態まで回復させる。

- ウォームスタート: システムの電源を切ることなく、ログの更新情報を使って処理を再開すること
- コールドスタート: システムの電源を入れ直し、システムの初期状態に戻してから処理を再開すること

# 06 データ操作とSQL
## 関係演算
関係データベースの表から目的のデータを取り出す演算

- 射影(projection): 表の中から特定の列を抽出する
- 選択(selection): 表の中から条件に合致した行を抽出する
- 結合(join): 2つ以上の表を結合して、1つの表を生成する

集合演算は、同じ列で構成される2つの表から新しい表を取り出す演算
- 和: 2つの表にあるすべての行を取り出す。同じ行は1つにまとめる
- 積: 2つの表に共通している行を取り出す
- 差: 一方の表から他方の表を取り除く

## SQL
データベースの表を定義したり、データを操作する言語

- データ定義言語: データベースや表などを定義する
- データ操作言語: データの抽出や挿入、更新、削除などを行う

## データ定義言語
| 構文 | 意味|
| ---- | --- |
| CREATE TABLE | 表を作成する **概念スキーマに相当する** |
| PRIMARY KEY | 主キーの設定 一意かつNULLの禁止 |
| FOREIGN KEY | 外部キーの設定 参照制約をつける |
| UNIQUE | 一意制約をつける |
| CHECK | 検査制約をつける |
| NOT NULL | NULLを許容しない |
| CREATE VIEW | ビュー表を作成する |

### ビューの定義
**ビュー**: 実際に存在する実表から必要な部分を取り出して、一時的に作成した表

CREATE VIEWの構文をつかう。**外部スキーマに該当する**。磁気ディスクに存在しない仮想表(導出表)

## データ操作言語
**SELECT**: 関係データベースの表から必要なデータを抽出するには

問い合わせ(クエリ): データを抽出すること

### SQLの実例
- 射影: select 品名 from 商品表
- 選択: select * from 商品表 where 番号= "10" or 番号="020" or 番号="030"
- 結合: select 顧客名, 商品名, 単価 from 受注表, 商品表 where 受注表.商品番号 = 商品表. 商品番号

# 07 SQLの並び替え・グループ化
## 並び替え
**ORDER BY**で並び替え可能。 ASCで昇順、DES降順

## 集合関数
指定した列の値を集計する関数

- SUM: 指定した列の合計
- AVG: 指定した列の平均
- MAX: 指定した列の最大化
- MIN: 指定した列の最小化
- COUNT: 指定した行数を求める

## グループ化
**GROUP BY**で、指定した列の内容が一致する行を1つの行にまとめて、グループ化できる

### AS
集合関数で求めた列に、別名をつけることができる

select 商品コード, SUM(販売数量) as 合計数量 from 販売表 group by 商品コード

### HAVING 
グループ化したものにつかうことで、グループに対する条件をつけることができる

select 商品コード, SUM(販売数量) as 合計数量 from 販売表 group by 商品コード having sum(販売数量) > 250

# SQL 副問合せ
selectの条件式のなかに、さらにselectを組み込み、一旦抽出した結果を条件として、再度抽出する

### INを使った副問合せ
「社員表の中からIPのスキルをを持っている人を抽出する」のように、再度問い合わせること

select * from 社員表 where 社員番号 in (select 社員番号 from 社員スキル表 where スキルコード="IP")

### NOT INを使った副問合せ
INの否定バージョン

select * from 社員表 where 社員番号 not in (select 社員番号 from 社員スキル表 where スキルコード="IP")

### EXISTSをつかった相関副問合せ
主問い合わせから副問合せに1行ずつ渡し、存在の有無を判断して「真」・「偽」の結果を、副問合せから主問い合わせに返すことを繰返しながら抽出すること

select * from 社員表 where exists (select * from 社員スキル表 where スキルコード="IP" and 社員表.社員番号=社員スキル表.社員番号)

### NOT EXISTSを使った相関副問合せ
EXISTSの否定バージョン

select * from 社員表 where not exists (select * from 社員スキル表 where スキルコード="IP" and 社員表.社員番号=社員スキル表.社員番号)

# 09 データベースの応用
## NoSQL
SQLを使わないで操作するデータベース全般

| 種類 | 特徴 | イメージ |
| ---- | ---- | -------- |
| キーバリューストア型 | 保存したいデータと、そのデータを一意に識別できるキーを組みとして管理する | 1, 伊藤 |
| カラム指向型 | キーに対するカラムを自由に追加できる | 1, 伊藤, 営業, 読書 |
| ドキュメント指向型 | ドキュメント1件が1つのデータとなる。データ構造は自由。XMLなどで記述する | 1, 伊藤, 営業, [読書, ドライブ] |
| グラフ指向型 | グラフ理論に基づき、ノード間を方向性のあるリレーションでつないで構造化する | 1, 伊藤, \n 2, 鈴木, \n 1,Follow-->,2 |

## データベースの応用
大量のデータを蓄積し、様々な形で有効活用する

- データウェアハウス: 企業の様々な活動を通して得られた大量のデータを整理・統合して蓄積したデータベース
- データレイク: 必要に応じて加工するため、データをハッセいしたままの未処理の形でリアルタイムに蓄積。データウェアハウスの1種
- データマート: 利用者が情報を利用するために、データウェアハウスから抽出した目的別のデータベース。
- データマイニング: 大量のデータベースを統計的・数学的手法で分析し、新たな法則や因果関係を見つけ出すこと
- BIツール: データウェアハウスやデータマートに蓄積された情報を、データマイニングなどで分析し、経営判断上の有用な情報を取り出すツール

## ビッグデータ
多種多様で高頻度に更新される大量のデータ

オープンデータ: 機械判読に適した形式で、原則無償で自由に二次利用できるよいうルールの下で、国や自治体、企業などが公開する官民データ

## データ資源の管理
- リポジトリ: ソフトウェアの開発や保守における設計情報やプログラム情報を一元的に管理するデータベース。データディクショナリなどに利用される
- データ項目の名称や意味を登録しているデータ辞書。
